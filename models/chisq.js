/**
 * Result from a Chi Squared test.
 * @class ResultChisq
 * @type {Object}
 * @property {Number} x0 Calculated x0
 * @param {Number} x0 Calculated x0
 * */
function ResultChisq(x0, xA, acceptance, error) {
  this.x0 = x0;
  this.xA = xA;
  this.acceptance = acceptance;
  this.error = error;
}

/**
 * Chi Cuadrada, pruebas de ajuste, distribucion uniforme.
 * @class Chisq
 * @type {Object}
 * @property {Array.<Number>} Ri_s The Randoms from 0 to 1
 * */
function Chisq() {
  this._Ri_s = [];
  this._alpha = "";
  this._k = 0;

  /**
   * Evaluate a set of Ri from a generated randoms.
   * @memberof Chisq
   * @param {Array.<Number>} Ri_s The Randoms from 0 to 1.
   * @returns {ResultChisq} The resulting variables of the Chi Squared test.
   * */
  this.test = function(Ri_s, alpha) {

    // Save  new values.
    this._Ri_s = Ri_s, this._alpha = alpha;

    // Calculate x0.
    let x0 = this._calculateX0(Ri_s);

    if (this._k > 250) {
      return new ResultChisq(0, 0, false, "KOUTOFBOUNDS");
    }

    // Get xalpha from table.
    let xA = this._calculateXA();

    // Check if it acceptance.
    let acceptance = x0 < xA;

    return new ResultChisq(x0, xA, acceptance, null);
  }

  // Calculate x0
  this._calculateX0 = function(Ri_s) {

    // Sort the array.
    let Ri_sorted = [...this._Ri_s].sort();

    // Get class size
    let cls_dim = this._calcClassDimension(Ri_sorted);
    let k = cls_dim.k;
    this._k = k;
    let cls_size = cls_dim.cls_size;

    // Get classes and frecuencies.
    classes = this._getFrecuencies(Ri_sorted, k, cls_size);

    // Fix classes with less than 5 ocurrences.
    classes = this._fixClassesFrec(classes);

    // Find Xi for every class.
    let xis = this._calcXi(classes);

    // Find x0
    let x0 = xis.reduce((prev, curr) => prev + curr, 0);

    x0 = Math.round((x0 + Number.EPSILON) * 10000) / 10000;
    
    return x0;
  }

  // Calculate xA.
  this._calculateXA = function() {
    let v = this._k - 1;
    let xA = CHI_TABLE[v-1][ALPHA_MAP[this._alpha]];
    return xA;
  }

  // Calculate class size
  this._calcClassDimension = function(items) {
    // Get N
    let n = items.length;

    // Find number of intervals with sturge's rule.
    let k = 1 + 3.322*Math.log10(n);
    k = Math.floor(k);

    // Find range
    let r = Math.max.apply(Math, items) - Math.min.apply(Math, items);

    // Class size is range over intervals.
    let cls_size = r / k;

    // Fit class size to cover the whole range 0 to 1.
    cls_size = cls_size + (1 - cls_size*k) / k

    // Get class size.
    return { "k": k, "cls_size": cls_size};
  }

  // Get all frecuency of classes.
  this._getFrecuencies = function(items, k, cls_size) {
    let classes = [];
    let l_fin = 0;
    for (let i = 0; i < k; i++) {
      let ini = l_fin;
      let fin = l_fin + cls_size;
      let freq_abs = this._getAbsFrec(items, ini, fin);
      classes.push({
        "ini": ini,
        "fin": fin,
        "abs_frec": freq_abs
      });
      l_fin += cls_size;
    }
    return classes;
  }

  // Calculate Xi for all classes.
  this._calcXi = function(classes) {
    let xis = [];
    let nClasses = classes.reduce((prev, curr) => prev + curr.abs_frec, 0);
    for (let i = 0; i < classes.length; i++) {
      // Probabilidad uniforme es el rango de la clase.
      let p = classes[i].fin - classes[i].ini;

      // Oi
      let oi = classes[i].abs_frec;

      // Ei
      let ei = p * nClasses;

      // Xi
      let xi = Math.pow(oi-ei, 2) / ei;

      xis.push(xi);
    }
    return xis;
  }

  //  Find the frecuency of objects within range.
  this._getAbsFrec = function(items, a, b) {
    return items.filter(item => item > a && item <= b).length;
  }

  // Fix the classes to match frecuencies bigger than 5.
  this._fixClassesFrec= function(classes) {
    // No classes case.
    if (classes.length == 0) {
      return classes;
    }

    // Fit classes such that absolute frecuency for each is above 5
    let newClasses = [];
    let carried_ini = classes[0].ini;
    let carried_fin = classes[0].fin;
    let carried_freq = classes[0].abs_frec;

    // One element.
    if (classes.length == 1) {
        newClasses.push({
          "ini": carried_ini,
          "fin": carried_fin,
          "abs_frec": carried_freq
        });
        return newClasses;
    }

    // Searching more elements.
    for (let i = 1; i < classes.length; i++) {
      if (carried_freq < 5) {
        carried_fin = classes[i].fin;
        carried_freq += classes[i].abs_frec;
      } else {
        newClasses.push({
          "ini": carried_ini,
          "fin": carried_fin,
          "abs_frec": carried_freq
        });
        carried_ini = classes[i].ini;
        carried_fin = classes[i].fin;
        carried_freq = classes[i].abs_frec;
      }
    }

    // Insert last, join with prior if frequency is less than 5.
    if (carried_freq < 5) {
      carried_ini = newClasses[newClasses.length - 1].ini;
      carried_freq += newClasses[newClasses.length - 1].abs_frec;
      newClasses[newClasses.length - 1] = {
        "ini": carried_ini,
        "fin": carried_fin,
        "abs_frec": carried_freq
      };
    } else {
      newClasses.push({
        "ini": carried_ini,
        "fin": carried_fin,
        "abs_frec": carried_freq
      });
    }
    
    return newClasses;
  }
}

if (typeof module !== "undefined") {
  module.exports = Chisq;
}

const ALPHA_MAP = {"0.1": 0, "0.05": 1, "0.02": 2, "0.01": 3}

const CHI_TABLE = [
	[2.706, 3.841, 5.024, 5.412], 
	[4.605, 5.991, 7.378, 7.824], 
	[6.251, 7.815, 9.348, 9.837], 
	[7.779, 9.488, 11.143, 11.668], 
	[9.236, 11.07, 12.833, 13.388], 
	[10.645, 12.592, 14.449, 15.033], 
	[12.017, 14.067, 16.013, 16.622], 
	[13.362, 15.507, 17.535, 18.168], 
	[14.684, 16.919, 19.023, 19.679], 
	[15.987, 18.307, 20.483, 21.161], 
	[17.275, 19.675, 21.92, 22.618], 
	[18.549, 21.026, 23.337, 24.054], 
	[19.812, 22.362, 24.736, 25.472], 
	[21.064, 23.685, 26.119, 26.873], 
	[22.307, 24.996, 27.488, 28.259], 
	[23.542, 26.296, 28.845, 29.633], 
	[24.769, 27.587, 30.191, 30.995], 
	[25.989, 28.869, 31.526, 32.346], 
	[27.204, 30.144, 32.852, 33.687], 
	[28.412, 31.41, 34.17, 35.02], 
	[29.615, 32.671, 35.479, 36.343], 
	[30.813, 33.924, 36.781, 37.659], 
	[32.007, 35.172, 38.076, 38.968], 
	[33.196, 36.415, 39.364, 40.27], 
	[34.382, 37.652, 40.646, 41.566], 
	[35.563, 38.885, 41.923, 42.856], 
	[36.741, 40.113, 43.195, 44.14], 
	[37.916, 41.337, 44.461, 45.419], 
	[39.087, 42.557, 45.722, 46.693], 
	[40.256, 43.773, 46.979, 47.962], 
	[41.422, 44.985, 48.232, 49.226], 
	[42.585, 46.194, 49.48, 50.487], 
	[43.745, 47.4, 50.725, 51.743], 
	[44.903, 48.602, 51.966, 52.995], 
	[46.059, 49.802, 53.203, 54.244], 
	[47.212, 50.998, 54.437, 55.489], 
	[48.363, 52.192, 55.668, 56.73], 
	[49.513, 53.384, 56.896, 57.969], 
	[50.66, 54.572, 58.12, 59.204], 
	[51.805, 55.758, 59.342, 60.436], 
	[52.949, 56.942, 60.561, 61.665], 
	[54.09, 58.124, 61.777, 62.892], 
	[55.23, 59.304, 62.99, 64.116], 
	[56.369, 60.481, 64.201, 65.337], 
	[57.505, 61.656, 65.41, 66.555], 
	[58.641, 62.83, 66.617, 67.771], 
	[59.774, 64.001, 67.821, 68.985], 
	[60.907, 65.171, 69.023, 70.197], 
	[62.038, 66.339, 70.222, 71.406], 
	[63.167, 67.505, 71.42, 72.613], 
	[64.295, 68.669, 72.616, 73.818], 
	[65.422, 69.832, 73.81, 75.021], 
	[66.548, 70.993, 75.002, 76.223], 
	[67.673, 72.153, 76.192, 77.422], 
	[68.796, 73.311, 77.38, 78.619], 
	[69.919, 74.468, 78.567, 79.815], 
	[71.04, 75.624, 79.752, 81.009], 
	[72.16, 76.778, 80.936, 82.201], 
	[73.279, 77.931, 82.117, 83.391], 
	[74.397, 79.082, 83.298, 84.58], 
	[75.514, 80.232, 84.476, 85.767], 
	[76.63, 81.381, 85.654, 86.953], 
	[77.745, 82.529, 86.83, 88.137], 
	[78.86, 83.675, 88.004, 89.32], 
	[79.973, 84.821, 89.177, 90.501], 
	[81.085, 85.965, 90.349, 91.681], 
	[82.197, 87.108, 91.519, 92.86], 
	[83.308, 88.25, 92.689, 94.037], 
	[84.418, 89.391, 93.856, 95.213], 
	[85.527, 90.531, 95.023, 96.388], 
	[86.635, 91.67, 96.189, 97.561], 
	[87.743, 92.808, 97.353, 98.733], 
	[88.85, 93.945, 98.516, 99.904], 
	[89.956, 95.081, 99.678, 101.074], 
	[91.061, 96.217, 100.839, 102.243], 
	[92.166, 97.351, 101.999, 103.41], 
	[93.27, 98.484, 103.158, 104.576], 
	[94.374, 99.617, 104.316, 105.742], 
	[95.476, 100.749, 105.473, 106.906], 
	[96.578, 101.879, 106.629, 108.069], 
	[97.68, 103.01, 107.783, 109.232], 
	[98.78, 104.139, 108.937, 110.393], 
	[99.88, 105.267, 110.09, 111.553], 
	[100.98, 106.395, 111.242, 112.712], 
	[102.079, 107.522, 112.393, 113.871], 
	[103.177, 108.648, 113.544, 115.028], 
	[104.275, 109.773, 114.693, 116.184], 
	[105.372, 110.898, 115.841, 117.34], 
	[106.469, 112.022, 116.989, 118.495], 
	[107.565, 113.145, 118.136, 119.648], 
	[108.661, 114.268, 119.282, 120.801], 
	[109.756, 115.39, 120.427, 121.954], 
	[110.85, 116.511, 121.571, 123.105], 
	[111.944, 117.632, 122.715, 124.255], 
	[113.038, 118.752, 123.858, 125.405], 
	[114.131, 119.871, 125, 126.554], 
	[115.223, 120.99, 126.141, 127.702], 
	[116.315, 122.108, 127.282, 128.849], 
	[117.407, 123.225, 128.422, 129.996], 
	[118.498, 124.342, 129.561, 131.142], 
	[119.589, 125.458, 130.7, 132.287], 
	[120.679, 126.574, 131.838, 133.431], 
	[121.769, 127.689, 132.975, 134.575], 
	[122.858, 128.804, 134.111, 135.718], 
	[123.947, 129.918, 135.247, 136.86], 
	[125.035, 131.031, 136.382, 138.002], 
	[126.123, 132.144, 137.517, 139.143], 
	[127.211, 133.257, 138.651, 140.283], 
	[128.298, 134.369, 139.784, 141.423], 
	[129.385, 135.48, 140.917, 142.562], 
	[130.472, 136.591, 142.049, 143.7], 
	[131.558, 137.701, 143.18, 144.838], 
	[132.643, 138.811, 144.311, 145.975], 
	[133.729, 139.921, 145.441, 147.111], 
	[134.813, 141.03, 146.571, 148.247], 
	[135.898, 142.138, 147.7, 149.383], 
	[136.982, 143.246, 148.829, 150.517], 
	[138.066, 144.354, 149.957, 151.652], 
	[139.149, 145.461, 151.084, 152.785], 
	[140.233, 146.567, 152.211, 153.918], 
	[141.315, 147.674, 153.338, 155.051], 
	[142.398, 148.779, 154.464, 156.183], 
	[143.48, 149.885, 155.589, 157.314], 
	[144.562, 150.989, 156.714, 158.445], 
	[145.643, 152.094, 157.839, 159.575], 
	[146.724, 153.198, 158.962, 160.705], 
	[147.805, 154.302, 160.086, 161.834], 
	[148.885, 155.405, 161.209, 162.963], 
	[149.965, 156.508, 162.331, 164.091], 
	[151.045, 157.61, 163.453, 165.219], 
	[152.125, 158.712, 164.575, 166.346], 
	[153.204, 159.814, 165.696, 167.473], 
	[154.283, 160.915, 166.816, 168.6], 
	[155.361, 162.016, 167.936, 169.725], 
	[156.44, 163.116, 169.056, 170.851], 
	[157.518, 164.216, 170.175, 171.976], 
	[158.595, 165.316, 171.294, 173.1], 
	[159.673, 166.415, 172.412, 174.224], 
	[160.75, 167.514, 173.53, 175.348], 
	[161.827, 168.613, 174.648, 176.471], 
	[162.904, 169.711, 175.765, 177.594], 
	[163.98, 170.809, 176.882, 178.716], 
	[165.056, 171.907, 177.998, 179.838], 
	[166.132, 173.004, 179.114, 180.959], 
	[167.207, 174.101, 180.229, 182.08], 
	[168.283, 175.198, 181.344, 183.2], 
	[169.358, 176.294, 182.459, 184.321], 
	[170.432, 177.39, 183.573, 185.44], 
	[171.507, 178.485, 184.687, 186.56], 
	[172.581, 179.581, 185.8, 187.678], 
	[173.655, 180.676, 186.914, 188.797], 
	[174.729, 181.77, 188.026, 189.915], 
	[175.803, 182.865, 189.139, 191.033], 
	[176.876, 183.959, 190.251, 192.15], 
	[177.949, 185.052, 191.362, 193.267], 
	[179.022, 186.146, 192.474, 194.384], 
	[180.094, 187.239, 193.584, 195.5], 
	[181.167, 188.332, 194.695, 196.616], 
	[182.239, 189.424, 195.805, 197.731], 
	[183.311, 190.516, 196.915, 198.846], 
	[184.382, 191.608, 198.025, 199.961], 
	[185.454, 192.7, 199.134, 201.076], 
	[186.525, 193.791, 200.243, 202.19], 
	[187.596, 194.883, 201.351, 203.303], 
	[188.667, 195.973, 202.459, 204.417], 
	[189.737, 197.064, 203.567, 205.53], 
	[190.808, 198.154, 204.675, 206.642], 
	[191.878, 199.244, 205.782, 207.755], 
	[192.948, 200.334, 206.889, 208.867], 
	[194.017, 201.423, 207.995, 209.978], 
	[195.087, 202.513, 209.102, 211.09], 
	[196.156, 203.602, 210.208, 212.201], 
	[197.225, 204.69, 211.313, 213.311], 
	[198.294, 205.779, 212.419, 214.422], 
	[199.363, 206.867, 213.524, 215.532], 
	[200.432, 207.955, 214.628, 216.641], 
	[201.5, 209.042, 215.733, 217.751], 
	[202.568, 210.13, 216.837, 218.86], 
	[203.636, 211.217, 217.941, 219.969], 
	[204.704, 212.304, 219.044, 221.077], 
	[205.771, 213.391, 220.148, 222.185], 
	[206.839, 214.477, 221.251, 223.293], 
	[207.906, 215.563, 222.353, 224.401], 
	[208.973, 216.649, 223.456, 225.508], 
	[210.04, 217.735, 224.558, 226.615], 
	[211.106, 218.82, 225.66, 227.722], 
	[212.173, 219.906, 226.761, 228.828], 
	[213.239, 220.991, 227.863, 229.935], 
	[214.305, 222.076, 228.964, 231.04], 
	[215.371, 223.16, 230.064, 232.146], 
	[216.437, 224.245, 231.165, 233.251], 
	[217.502, 225.329, 232.265, 234.356], 
	[218.568, 226.413, 233.365, 235.461], 
	[219.633, 227.496, 234.465, 236.566], 
	[220.698, 228.58, 235.564, 237.67], 
	[221.763, 229.663, 236.664, 238.774], 
	[222.828, 230.746, 237.763, 239.877], 
	[223.892, 231.829, 238.861, 240.981], 
	[224.957, 232.912, 239.96, 242.084], 
	[226.021, 233.994, 241.058, 243.187], 
	[227.085, 235.077, 242.156, 244.29], 
	[228.149, 236.159, 243.254, 245.392], 
	[229.213, 237.24, 244.351, 246.494], 
	[230.276, 238.322, 245.448, 247.596], 
	[231.34, 239.403, 246.545, 248.698], 
	[232.403, 240.485, 247.642, 249.799], 
	[233.466, 241.566, 248.739, 250.9], 
	[234.529, 242.647, 249.835, 252.001], 
	[235.592, 243.727, 250.931, 253.102], 
	[236.655, 244.808, 252.027, 254.202], 
	[237.717, 245.888, 253.122, 255.302], 
	[238.78, 246.968, 254.218, 256.402], 
	[239.842, 248.048, 255.313, 257.502], 
	[240.904, 249.128, 256.408, 258.601], 
	[241.966, 250.207, 257.503, 259.701], 
	[243.028, 251.286, 258.597, 260.8], 
	[244.09, 252.365, 259.691, 261.898], 
	[245.151, 253.444, 260.785, 262.997], 
	[246.213, 254.523, 261.879, 264.095], 
	[247.274, 255.602, 262.973, 265.193], 
	[248.335, 256.68, 264.066, 266.291], 
	[249.396, 257.758, 265.159, 267.389], 
	[250.457, 258.837, 266.252, 268.486], 
	[251.517, 259.914, 267.345, 269.584], 
	[252.578, 260.992, 268.438, 270.681], 
	[253.638, 262.07, 269.53, 271.777], 
	[254.699, 263.147, 270.622, 272.874], 
	[255.759, 264.224, 271.714, 273.97], 
	[256.819, 265.301, 272.806, 275.066], 
	[257.879, 266.378, 273.898, 276.162], 
	[258.939, 267.455, 274.989, 277.258], 
	[259.998, 268.531, 276.08, 278.354], 
	[261.058, 269.608, 277.171, 279.449], 
	[262.117, 270.684, 278.262, 280.544], 
	[263.176, 271.76, 279.352, 281.639], 
	[264.235, 272.836, 280.443, 282.734], 
	[265.294, 273.911, 281.533, 283.828], 
	[266.353, 274.987, 282.623, 284.922], 
	[267.412, 276.062, 283.713, 286.016], 
	[268.471, 277.138, 284.802, 287.11], 
	[269.529, 278.213, 285.892, 288.204], 
	[270.588, 279.288, 286.981, 289.298], 
	[271.646, 280.362, 288.07, 290.391], 
	[272.704, 281.437, 289.159, 291.484], 
	[273.762, 282.511, 290.248, 292.577], 
	[274.82, 283.586, 291.336, 293.67], 
	[275.878, 284.66, 292.425, 294.762], 
	[276.935, 285.734, 293.513, 295.855], 
	[277.993, 286.808, 294.601, 296.947], 
	[279.05, 287.882, 295.689, 298.039]
];
